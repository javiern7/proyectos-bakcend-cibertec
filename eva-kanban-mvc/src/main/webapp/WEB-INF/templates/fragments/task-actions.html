<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="actions (task, user)" class="task-actions">
    <!-- ADMIN: todo habilitado -->
    <div th:if="${user != null and user.role != null and user.role.toString() == 'ADMIN'}">
        <a th:href="@{'/task/edit/' + ${task.id}}" class="btn btn-sm btn-outline-secondary me-2">Editar</a>

        <!-- siguiente estado (si aplica) -->
        <form th:if="${task.status.name() == 'ASSIGNED'}"
              th:action="@{'/task/' + ${task.id} + '/status'}" method="post" class="d-inline">
            <input type="hidden" name="status" value="IN_PROGRESS"/>
            <button class="btn btn-sm btn-outline-primary me-2">→ En Proceso</button>
        </form>
        <form th:if="${task.status.name() == 'IN_PROGRESS'}"
              th:action="@{'/task/' + ${task.id} + '/status'}" method="post" class="d-inline">
            <input type="hidden" name="status" value="DONE"/>
            <button class="btn btn-sm btn-outline-primary me-2">→ En Terminado</button>
        </form>

        <form th:action="@{'/task/' + ${task.id} + '/delete'}"
              method="post" class="d-inline"
              onsubmit="return confirm('¿Eliminar la tarea?');">
            <button class="btn btn-sm btn-outline-danger">Eliminar</button>
        </form>
    </div>

    <!-- USER dueño de la tarea: solo avanzar, no editar/elim.; en DONE se inhabilita -->
    <div th:if="${user != null and user.username == task.username and task.status.name() != 'DONE'}">
        <button class="btn btn-sm btn-outline-secondary me-2" disabled data-bs-toggle="tooltip" title="Solo admin puede editar">
            Editar
        </button>

        <form th:if="${task.status.name() == 'ASSIGNED'}"
              th:action="@{'/task/' + ${task.id} + '/status'}" method="post" class="d-inline">
            <input type="hidden" name="status" value="IN_PROGRESS"/>
            <button class="btn btn-sm btn-outline-primary me-2">→ En Proceso</button>
        </form>
        <form th:if="${task.status.name() == 'IN_PROGRESS'}"
              th:action="@{'/task/' + ${task.id} + '/status'}" method="post" class="d-inline">
            <input type="hidden" name="status" value="DONE"/>
            <button class="btn btn-sm btn-outline-primary me-2">→ En Terminado</button>
        </form>

        <button class="btn btn-sm btn-outline-danger" disabled data-bs-toggle="tooltip" title="Solo admin puede eliminar">
            Eliminar
        </button>
    </div>

    <!-- Otros usuarios o DONE: todo deshabilitado -->
    <div th:if="${user == null or user.username != task.username or task.status.name() == 'DONE'}">
        <button class="btn btn-sm btn-outline-secondary me-2" disabled data-bs-toggle="tooltip" title="Solo admin puede editar">Editar</button>
        <button class="btn btn-sm btn-outline-primary  me-2" disabled data-bs-toggle="tooltip" title="No puedes cambiar estado">Cambiar estado</button>
        <button class="btn btn-sm btn-outline-danger" disabled data-bs-toggle="tooltip" title="Solo admin puede eliminar">Eliminar</button>
    </div>
</div>
</body>
</html>
